function roundNumber(t,e){var n="number"==typeof e?e:2;return(Math.round(t*Math.pow(10,n))/Math.pow(10,n)).toFixed(e)}function readSingleFile(t){var e=t.target.files[0];e&&((t=new FileReader).readAsText(e,"UTF-8"),t.onload=function(t){drawer.upload(t.target.result.toString())})}const defaultZoom=13.5;function ReadCookie(){cookies={};for(var t,e,n=document.cookie.split(";"),o=0;o<n.length;o++)name=n[o].split("=")[0],cookies[name.trim()]=n[o].split("=")[1];return cookies.hasOwnProperty("latitude")&&cookies.hasOwnProperty("longitude")&&(t=Number(cookies.latitude),e=Number(cookies.longitude)),isNaN(t)||isNaN(e)?{lat:53.2672,lng:-1.63}:(document.getElementById("latitude").value=cookies.latitude,document.getElementById("longitude").value=cookies.longitude,{lat:t,lng:e})}function distance2DPoints(t,e,n,o){return Math.sqrt(Math.pow(t-n,2)+Math.pow(e-o,2))}var mkVect2D=function(){var o={x:0,y:0,add:function(t){this.x+=t.x,this.y+=t.y},subs:function(t){this.x-=t.x,this.y-=t.y},multiply:function(t){this.x*=t,this.y*=t},add2:function(t,e){this.x+=t,this.y+=e},length:function(){return distance2DPoints(this.x,this.y,0,0)},clone:function(){return mkVect2D(this.x,this.y)},normalise:function(){this.multiply(1/this.length())},distance:function(t){if("object"==typeof t)return distance2DPoints(this.x,this.y,t.x,t.y);throw"parameter passed is not an object."},setPositionAt:function(t,e){this.x=t,this.y=e},copyTo:function(t){t.x=this.x,t.y=this.y},print:function(){return"("+this.x+", "+this.y+")"}};return function(t,e){var n=Object.create(o);return n.setPositionAt(t,e),n}}();Conversion={a:1/60,b:1/3600,kmToDDNorth:function(){var o=110.574,i=o/60;return function(t){var e=t/o,n=Math.floor(e),e=t-n*o,t=Math.floor(e/i);return n+(60*t+(e-t*i)/.030715)/3600}}(),kmToDDEast:function(){var n,o,i,s,a=Math.PI/180;return function(t,e){s=111.321*Math.cos(a*t),n=s/60,o=s/3600,i=e/s;t=Math.floor(i);s=e-t*s;e=Math.floor(s/n);return t+(60*e+(s-e*n)/o)/3600}}(),toECEF:function(){var t=6378137,e=6356752.3,s=t*t,a=e*e,r=Math.PI/180;return function(t,e,n){var o=Math.sqrt(s*Math.pow(Math.cos(r*t),2)+a*Math.pow(Math.sin(r*t),2)),i=s/o,o=(i+n)*Math.cos(r*t)*Math.cos(r*e),e=(i+n)*Math.cos(r*t)*Math.sin(r*e),t=(a/s*i+n)*Math.sin(r*t);return roundNumber(o,3)+", "+roundNumber(e,3)+", "+roundNumber(t,3)}}()},Settings={alt:30,currentZoom:14.25,setAltitude:function(t){this.alt=Number(t)},initialZoom:function(){return 14.25},zoomDelta:function(){return.25},updateZoom:function(t){currentZoom+=t}},Settings;var map=L.map("map",{minZoom:0,zoomSnap:0,zoomDelta:.25,zoomControl:!1});!function(){var t=document.getElementById("container"),e=document.getElementById("speed-panel"),e=window.innerHeight-e.offsetHeight;t.style.height=document.body.clientHeight+"px",t.style.height=window.innerHeight+"px",document.getElementById("canvasContainer").style.height=e+"px",document.getElementById("canvas").style.height=e+"px",document.getElementById("map").style.height=e+"px",document.getElementById("left_pannel").style.height=e+"px",t=document.getElementById("canvas").clientWidth,globalSettings={canvas:document.getElementById("canvas"),baseZ:14.25,grid:[],Height:e,Width:t,scaleFactor:206,getScaleFactor:function(){return this.scaleFactor},gridSettings:{stroke:"#2929a3","stroke-width":.2,opacity:.6},paper:Raphael("canvas",t,e),wMtPx:0,hMtPx:0,mkGrid:function(){if(0<this.grid.length){for(var t=0;t<this.grid.length;t++)this.grid[t].remove();this.grid.length=0}var e=map.distance(map.containerPointToLatLng(L.point(0,0)),map.containerPointToLatLng(L.point(this.Width,0)));this.wMtPx=e/this.Width;e=map.distance(map.containerPointToLatLng(L.point(0,0)),map.containerPointToLatLng(L.point(0,this.Height)));this.hMtPx=e/this.Height;for(var n=1e3/this.hMtPx,o=Math.floor(this.Height/n),t=0;t<o;t++)this.grid.push(this.paper.path("M0,"+(t+1)*n+"L"+this.Width+","+(t+1)*n).attr(this.gridSettings));var i=1e3/this.wMtPx,s=Math.floor(this.Width/i);this.scaleFactor=Math.floor(i),this.scFacInv=1/this.scaleFactor;for(t=0;t<s;t++)this.grid.push(this.paper.path("M"+(t+1)*i+",0L"+(t+1)*i+","+this.Height).attr(this.gridSettings))},mtsToPxs:function(t){return.001*t*this.scaleFactor},kmsToPxs:function(t){return t*this.scaleFactor},pixelsToKms:function(t){return t*this.scFacInv},pixelsToMts:function(t){return 1e3*this.pixelsToKms(t)},containerPointToLatLng:function(t,e){var n=map.getCenter(),e=Number(n.lat+Conversion.kmToDDNorth((.5*this.Height-e)*this.scFacInv));return{lat:e,lng:Number(n.lng+Conversion.kmToDDEast(e,(t-.5*this.Width)*this.scFacInv))}},containerCenter:function(){return mkVect2D(.5*this.Width,.5*this.Height)},latLngToPixelCoordinates:function(t){var e=this.mtsToPxs(map.distance(t,map.getCenter())),n=this.containerCenter(),o=map.latLngToContainerPoint(t),i=e/distance2DPoints(n.x,n.y,o.x,o.y),t=i*Math.abs(n.x-o.x),e=i*Math.abs(n.y-o.y),i={x:n.x+t,y:n.y+e};return o.x<=n.x&&(i.x=n.x-t),o.y<=n.y&&(i.y=n.y-e),i},latLngToMtsCoordinates:function(t){var e=map.distance(t,map.getCenter()),n=this.containerCenter(),t=map.latLngToContainerPoint(t),e=e/distance2DPoints(n.x,n.y,t.x,t.y);return{x:e*(t.x-n.x),y:e*(n.y-t.y)}},mtsCoordinatesToPxs:function(t,e){return mkVect2D(this.mtsToPxs(t)+.5*this.Width,-1*this.mtsToPxs(e)+.5*this.Height)},mtsCooPxs:function(t,e,n){n(this.mtsToPxs(t)+.5*this.Width,-1*this.mtsToPxs(e)+.5*this.Height)},mtsCooPxs2:function(t,e){return{transform:"t"+(this.mtsToPxs(t)+.5*this.Width)+","+(-1*this.mtsToPxs(e)+.5*this.Height)}},getPosition:function(e){var n=this.canvas.getBoundingClientRect().left,o=this.canvas.getBoundingClientRect().top,i=n+this.Width,s=o+this.Height;function t(t){x=t.clientX,y=t.clientY,x>n&&x<i&&y>o&&y<s&&e(x-n,y-o)}function a(){document.onmouseup=null,document.onmousemove=null}canvas.onmousedown=function(){document.onmouseup=a,document.onmousemove=t}},getPosition3:function(t,e){var n=this.canvas.getBoundingClientRect().left,o=this.canvas.getBoundingClientRect().top,i=n+this.Width,s=o+this.Height;x=e.clientX,y=e.clientY,x>n&&x<i&&y>o&&y<s&&t(x-n,y-o)}},globalSettings}(),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'}).addTo(map),L.control.scale({maxWidth:300}).addTo(map);var mkObjectEvt=function(){var e={addHandler:function(t,e){this.handlers[t]=this.handlers[t]||[],this.handlers[t].push(e)},fire:function(t){for(var e in this.handlers[t])this.handlers[t][e].apply(null,Array.prototype.slice.call(arguments,1))}};return function(){var t=Object.create(e);return t.handlers={},t}}();controlModule=mkObjectEvt(),controlModule.playButton=document.getElementById("playButton"),controlModule.pauseButton=document.getElementById("pauseButton"),controlModule.recordButton=document.getElementById("recordButton"),controlModule.recordingButton=document.getElementById("recordingButton"),controlModule.deleteButton=document.getElementById("deletButton"),controlModule.eraseButton=document.getElementById("eraseButton"),controlModule.appendButton=document.getElementById("appendButton"),controlModule.resetButton=document.getElementById("resetButton"),controlModule.exportButton=document.getElementById("export"),controlModule.exportDataButton=document.getElementById("exportData"),controlModule.exportGPXButton=document.getElementById("exportGPX"),controlModule.disableButtons=function(t){controlModule.deleteButton.disabled=t,controlModule.eraseButton.disabled=t,controlModule.appendButton.disabled=t,controlModule.resetButton.disabled=t,controlModule.exportButton.disabled=t,controlModule.exportDataButton.disabled=t,controlModule.exportGPXButton.disabled=t},controlModule.addHandler("reset",function(){controlModule.pauseButton.style.display="none",controlModule.playButton.style.display="none",controlModule.recordingButton.style.display="none",controlModule.recordButton.style.display="block",controlModule.disableButtons(!1)}),controlModule.init=function(){document.getElementById("upload").addEventListener("change",readSingleFile);var e=globalSettings.baseZ;controlModule.setZoom=function(t){(e=.25*Math.floor(t/.25))<12&&(e=globalSettings.baseZ),map.setZoom(e)},document.getElementById("zoom_less").addEventListener("click",function(){11<=e-.25&&(e-=.25,map.setZoom(e))}),document.getElementById("zoom_more").addEventListener("click",function(){e+.25<=17&&(e+=.25,map.setZoom(e))});var n=1;controlModule.setSpeedTime=function(t){0<t&&t<6&&(n=t,controlModule.fire("timeFactor",n),document.getElementById("x_time").innerHTML="x"+n)},document.getElementById("time_speed_less").addEventListener("click",function(){1<n&&(n--,controlModule.setSpeedTime(n))}),document.getElementById("time_speed_more").addEventListener("click",function(){n<5&&(n++,controlModule.setSpeedTime(n))}),this.playButton.addEventListener("click",function(){controlModule.fire("play"),controlModule.playButton.style.display="none",controlModule.pauseButton.style.display="block"}),this.pauseButton.addEventListener("click",function(){controlModule.fire("pause"),controlModule.pauseButton.style.display="none",controlModule.playButton.style.display="block"}),this.recordButton.addEventListener("click",function(){controlModule.recordButton.style.display="none",controlModule.recordingButton.style.display="block",controlModule.disableButtons(!0),controlModule.fire("record")}),this.deleteButton.addEventListener("click",function(){controlModule.fire("delete"),controlModule.pauseButton.style.display="none",controlModule.playButton.style.display="none",controlModule.recordingButton.style.display="none",controlModule.recordButton.style.display="block",controlModule.eraseButton.disabled=!1,controlModule.appendButton.disabled=!1,controlModule.exportButton.disabled=!0,controlModule.exportDataButton.disabled=!0,controlModule.exportGPXButton.disabled=!0}),this.resetButton.addEventListener("click",function(){controlModule.fire("reset"),controlModule.exportButton.disabled=!0,controlModule.exportDataButton.disabled=!0,controlModule.exportGPXButton.disabled=!0}),this.eraseButton.addEventListener("click",function(){controlModule.fire("erase")}),this.appendButton.addEventListener("click",function(){controlModule.fire("append")}),this.addHandler("readyToPlay",function(){controlModule.pauseButton.style.display="none",controlModule.playButton.style.display="block"}),this.addHandler("recordingFinished",function(){controlModule.recordingButton.style.display="none",controlModule.recordButton.style.display="none",controlModule.playButton.style.display="block",controlModule.disableButtons(!1),controlModule.eraseButton.disabled=!0,controlModule.appendButton.disabled=!0})},controlModule.altitude=10,controlModule.setAltitude=function(t){controlModule.altitude=Math.abs(t),controlModule.fire("altitudeChanged",controlModule.altitude)},controlModule.changeAltitude=function(t){40==t?5<=controlModule.altitude&&(controlModule.altitude-=5):38==t&&(controlModule.altitude<1495?controlModule.altitude+=5:controlModule.altitude=1500),controlModule.fire("altitudeChanged",controlModule.altitude)},controlModule.exportButton.disabled=!0,controlModule.exportDataButton.disabled=!0,controlModule.exportGPXButton.disabled=!0,controlModule;var ZoomViewer=L.Control.extend({onAdd:function(){var t=L.DomUtil.create("div"),n=L.DomUtil.create("div");return t.style.width="200px",t.style.background="rgba(255,255,255,0.5)",t.style.tespeedTimeAlign="left",map.on("zoomstart zoom zoomend",function(t){var e=map.getZoom();n.innerHTML="Zoom level: "+e,controlModule.fire("scaleChange",e-globalSettings.baseZ)}),t.appendChild(n),t}});(new ZoomViewer).addTo(map);var popUpAPI,gadgetModule=function(){var i=mkObjectEvt();return i.distance=document.getElementById("distance"),i.totalDistance=document.getElementById("Tdistance"),i.speed=document.getElementById("speed"),i.altitude=document.getElementById("altitude"),i.elapsedTime=document.getElementById("elapsedtime"),i.averageSpeed=document.getElementById("average_speed"),i.active=!1,i.reset=!1,i.timer=function(){var e,n=0,o=1;i.resetR=function(){n=0},i.setFactor=function(t){o=1};return function(t){e=roundNumber(.001*(n+=o*t),2),gadgetModule.elapsedTime.innerHTML=e}}(),i.changeTimeFactor=function(t){i.factor=t,i.setFactor(t)},i.resetTimer=function(){i.factor=1,i.active=!1,i.resetR(),i.elapsedTime.innerHTML="0.00"},i.startTimer=function(){i.active=!0},i.stopTimer=function(){i.active=!1},i.updateAlt=function(t){i.altitude.innerHTML=t},i.updateSpeed=function(t){i.speed.innerHTML=t},i}(),mkPOI=function(){var r={geoPosition2D:null,POI:null,lat:"lat",lng:0,setAttr:function(t){this.POI.attr(t)},pointToLatLng:function(t,e){e=globalSettings.containerPointToLatLng(t,e);this.lat=e.lat,this.lng=e.lng},setPositionXY:function(t,e){this.POI.attr({transform:"t"+t+","+e}),this.POI.toFront(),this.pointToLatLng(t,e),this.geoPosition2D=globalSettings.latLngToMtsCoordinates({lat:this.lat,lng:this.lng})},setLatLng:function(t){this.lat=t.lat,this.lng=t.lng;t=globalSettings.latLngToPixelCoordinates(t);this.POI.attr({transform:"t"+t.x+","+t.y}),this.POI.toFront(),this.geoPosition2D=globalSettings.latLngToMtsCoordinates({lat:this.lat,lng:this.lng})},onZoom:function(){var t=globalSettings.latLngToPixelCoordinates({lat:this.lat,lng:this.lng});this.POI.attr({transform:"t"+t.x+","+t.y}),this.POI.toFront()},translate:function(t,e){this.POI.translate(t,e),this.POI.toFront(),this.geoPosition2D=globalSettings.latLngToMtsCoordinates({lat:this.lat,lng:this.lng})},getGeoX:function(){return this.geoPosition2D.x},getGeoY:function(){return this.geoPosition2D.y},positionToECEF:function(t){Conversion.toECEF(this.lat,this.lng,t)},remove:function(){this.POI.remove()},getLatLng:function(){return{lat:this.lat,lng:this.lng}},setColour:function(t){this.POI.attr({stroke:"none",fill:t})}};return function(t,e,n,o){var i=Object.create(r),s=2,a={stroke:"none"};return void 0!==n&&"object"==typeof n&&(a=n,void 0!==o&&(s=o)),i.POI=globalSettings.paper.circle(0,0,s),i.POI.attr(a),i.setPositionXY(t,e),i}}();!function(){var n,o,i;Trail={set:[],directions:[],looping:function(t){for(var e=0;e<this.set.length;e++)t(this.set[e])},onZoom:function(){this.looping(function(t){t.onZoom()}),this.mover.attr(globalSettings.mtsCooPxs2(this.currentGeoPos.x,this.currentGeoPos.y)),this.mover.toFront()},onTranslate:function(e,n){this.looping(function(t){t.translate(e,n)}),this.mover.translate(e,n),this.mover.toFront()},reset:function(){this.looping(function(t){t.remove()}),this.set.length=0,this.directions.length=0,this.trailLength=0,this.segmentNum=0,this.distanceMt=0},removeLast:function(){var t;0<this.set.length&&(0<(t=this.set.length-1)&&(this.trailLength-=this.segmentMtLength(t-1)),this.set[t].remove(),this.set.pop())},trailPOIcolour:"#ffb366",trailLength:0,mover:null,init:function(){this.mover=globalSettings.paper.circle(0,0,2),this.mover.attr({stroke:"none",fill:"blue"}),this.mover.attr({transform:"t-100,-100"})},addPoint:function(t,e){this.set.push(mkPOI(t,e,{stroke:"none",fill:this.trailPOIcolour})),this.setUp()},addPointLatLng:function(t){this.set.push(mkPOI(0,0,{stroke:"none",fill:this.trailPOIcolour}));var e=this.set.length-1;this.set[e].setLatLng(t),this.setUp()},setUp:function(){var t;1<this.set.length&&(t=this.set.length-1,this.directions.push(mkVect2D(this.getGeoX(t)-this.getGeoX(t-1),this.getGeoY(t-1)-this.getGeoY(t))),this.trailLength+=this.segmentMtLength(t-1),t=this.directions.length-1,this.directions[t].normalise())},getTrailLengthKm:function(){return.001*this.trailLength},segmentMtLength:function(t){if(t<this.set.length-1)return distance2DPoints(this.getGeoX(t),this.getGeoY(t),this.getGeoX(t+1),this.getGeoY(t+1));throw"something wrong in segmentMtLength"},getGeoX:function(t){return this.set[t].getGeoX()},getGeoY:function(t){return this.set[t].getGeoY()},getLastGeoX:function(){return this.set[this.set.length-1].getGeoX()},getLastGeoY:function(){return this.set[this.set.length-1].getGeoY()},currentGeoPos:mkVect2D(0,0),moveToStart:function(){0<this.set.length&&(this.currentGeoPos.setPositionAt(this.getGeoX(0),this.getGeoY(0)),this.mover.attr(globalSettings.mtsCooPxs2(this.currentGeoPos.x,this.currentGeoPos.y)),this.mover.toFront(),this.segmentNum=0)},moveToNext:function(t){this.currentGeoPos.add(this.deltaGeo),this.mover.animate(globalSettings.mtsCooPxs2(this.currentGeoPos.x,this.currentGeoPos.y),t,"linear"),this.mover.toFront()},segmentNum:0,distanceMt:0,deltaGeo:mkVect2D(0,0),getDelta:function(t,e){return this.segmentNum+1==this.set.length?{time:-1}:(this.distanceMt<=0&&(this.distanceMt=this.segmentMtLength(this.segmentNum)),o=t*(1/3600),n=this.distanceMt/o,i=!0,250<n&&(550<n?i=!(n=300):420<n&&(n*=.5,i=!1)),o=o*n,this.distanceMt-=o,this.directions[this.segmentNum].copyTo(this.deltaGeo),this.deltaGeo.multiply(o),this.deltaGeo.y*=-1,this.moveToNext(n,e),i&&(this.distanceMt=0,this.segmentNum++),{time:n,distance:.001*o,geoX:this.currentGeoPos.x,geoY:this.currentGeoPos.y})},exportData:function(){for(var t=[],e=0;e<this.set.length;e++)t.push(this.set[e].getLatLng());return t},setColours:function(t,e){if(""!=e&&this.mover.attr({stroke:"none",fill:e}),""!=t){this.trailPOIcolour=t;for(var n=0;n<this.set.length;n++)this.set[n].setColour(this.trailPOIcolour)}}},Trail}();var drawer={speedTime:2,status:0,getPositionFromPointer:!1,offSetX:-1.63,offSetY:53.2672,altitude:10,init:function(){globalSettings.getPosition(function(t,e){drawer.getData(t,e)}),Trail.init(),controlModule.init(),this.setSpeed(10),controlModule.addHandler("timeFactor",function(t){drawer.speedTime=t,gadgetModule.changeTimeFactor(t)}),controlModule.setSpeedTime(0),controlModule.addHandler("play",function(){drawer.getPositionFromPointer=!1,document.getElementById("moveToBtn").style.fontWeight="normal",drawer.play()}),controlModule.addHandler("record",function(){drawer.isRecording=!0,drawer.getPositionFromPointer=!1,document.getElementById("moveToBtn").style.fontWeight="normal",drawer.record()}),controlModule.addHandler("pause",function(){drawer.halt()}),controlModule.addHandler("reset",function(){drawer.reset()}),controlModule.addHandler("delete",function(){drawer.erase()}),controlModule.addHandler("erase",function(){drawer.deleteLast()}),controlModule.addHandler("append",function(){drawer.append()}),controlModule.addHandler("scaleChange",function(t){drawer.mapReady()&&(globalSettings.mkGrid(),Trail.onZoom())}),controlModule.addHandler("altitudeChanged",function(t){drawer.altitude=t,gadgetModule.updateAlt(t)}),controlModule.setAltitude(10)},mxG:10,speedData:[],altData:[],lastX:0,lastY:0,getData:function(t,e){if(!(0<this.status||this.getPositionFromPointer)){var n,o=0;if(0<this.head&&(n=globalSettings.mtsCoordinatesToPxs(Trail.getGeoX(this.head-1),Trail.getGeoY(this.head-1)),this.lastX=n.x,this.lastY=n.y,o=distance2DPoints(this.lastX,this.lastY,t,e)),o>this.mxG){this.head;var i=Math.ceil(o/this.mxG),s=1;t-this.lastX<0&&(s=-1);var a=1;e-this.lastY<0&&(a=-1);for(var r=Math.abs(t-this.lastX)/i,d=Math.abs(e-this.lastY)/i,l=1;l<i;l++)Trail.addPoint(this.lastX+l*r*s,this.lastY+l*d*a),this.head++}(o>this.mxG||0==this.head)&&(Trail.addPoint(t,e),this.head++,gadgetModule.totalDistance.innerHTML=roundNumber(Trail.getTrailLengthKm(),2))}},deleteLast:function(){0<this.status&&1<this.head||(this.head--,Trail.removeLast(),0<this.head&&(gadgetModule.totalDistance.innerHTML=roundNumber(Trail.getTrailLengthKm(),2)))},append:function(){this.status=0},counter:0,head:0,paused:!1,halt:function(){this.paused=!0},isRunning:!1,speed:1,play:function(){this.paused&&(gadgetModule.startTimer(),this.paused=!1,this.run()),this.isRunning||(this.counter=0,this.wkDistance=0,this.status=1,gadgetModule.resetTimer(),gadgetModule.startTimer(),Trail.moveToStart(),0<this.speed&&(this.isRunning=!0,this.counter++,this.run()))},wkDistance:0,run:function(){var t=!0,e=0;return function(){this.paused||(t?(this.isRunning&&(gadgetModule.speed.innerHTML=roundNumber(this.speedData[e],2),gadgetModule.updateAlt(this.altData[e])),dt=Trail.getDelta(this.speedData[e++],this.speedTime),t=0<=dt.time&&e<this.speedData.length,0<dt.time?(setTimeout(function(){gadgetModule.timer(dt.time),this.run()}.bind(this),dt.time/this.speedTime),this.wkDistance+=dt.distance,gadgetModule.distance.innerHTML=roundNumber(this.wkDistance,2)):(this.run(),t=!0,e=0)):(this.isRunning&&controlModule.fire("readyToPlay"),this.isRunning=!1))}}(),canMove:function(){return!this.isRunning&&!this.isRecording},resetRecording:!0,dataR:[],timeOutID:0,isRecording:!1,record:function(){var t=!0;return function(){if(0==this.head)return controlModule.fire("reset"),void(this.isRecording=!1);this.resetRecording&&(t=!0,this.resetRecording=!1,this.dataR.length=0,this.dataR.push([Trail.getGeoX(0),Trail.getGeoY(0)]),this.speedData.length=0,this.speedData.push(this.speed),this.altData.length=0,this.altData.push(this.altitude),Trail.moveToStart(),this.status=1,gadgetModule.startTimer()),t?(this.altData.push(this.altitude),this.speedData.push(this.speed),dt=Trail.getDelta(this.speed,this.speedTime),t=0<=dt.time,0<dt.time?(this.dataR.push([dt.geoX,dt.geoY]),this.timeOutID=setTimeout(function(){gadgetModule.timer(dt.time),this.record()}.bind(this),dt.time/this.speedTime),this.wkDistance+=dt.distance,gadgetModule.distance.innerHTML=roundNumber(this.wkDistance,2)):this.record()):(this.altData.push(this.altitude),this.speedData.push(this.speed),this.dataR.push([Trail.getLastGeoX(),Trail.getLastGeoY()]),controlModule.fire("recordingFinished"),this.isRecording=!1)}}(),clearData:function(){this.dataR.length=0,this.speedData.length=0,this.altData.length=0},erase:function(){this.clearData(),this.resetRecording=!0,this.head=0,Trail.reset(),gadgetModule.totalDistance.innerHTML="0.00",gadgetModule.distance.innerHTML="0.00",this.counter=0,this.wkDistance=0,this.isRunning=!1,this.paused=!1,this.status=0,gadgetModule.resetTimer(),this.setSpeed(10)},reset:function(){this.clearData(),this.resetRecording=!0,gadgetModule.distance.innerHTML="0.00",Trail.moveToStart(),this.counter=0,this.wkDistance=0,this.isRunning=!1,this.paused=!1,gadgetModule.resetTimer(),gadgetModule.speed.innerHTML=roundNumber(this.speed,2)},segmentLength:function(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))},changeFrequency:function(t){this.frequency=t},isMapReady:!1,mapReady:function(){return this.isMapReady},setCoordinates:function(t,e,n){this.offSetX=Number(e),this.offSetY=Number(t),map.setView([Number(t),Number(e)],n),this.isMapReady=!0,globalSettings.mkGrid()},frequency:10,toECEF:!0,processData:function(t){if(0!=this.dataR.length){var e,n=1/this.frequency,o=!1,i=n,s=[],a=Number(0),r=this.offSetY+Conversion.kmToDDNorth(.001*this.dataR[0][1]),d=this.altData[0];this.toECEF?(s.push([a.toFixed(1),Conversion.toECEF(r,this.offSetX+Conversion.kmToDDEast(r,.001*this.dataR[0][0]),d)]),a+=.1):s.push([r,this.offSetX+Conversion.kmToDDEast(r,.001*this.dataR[0][0]),d]);for(var l=1;l<this.dataR.length;l++)if(d=this.altData[l],e=this.segmentLength(this.dataR[l],this.dataR[l-1]),!isNaN(e)){var u=this.speedData[l-1]*(10/36);if(0!=u){for(var c,h,m=e/u,g=i*u,p=(c=(this.dataR[l][0]-this.dataR[l-1][0])/e)*g,f=(h=(this.dataR[l][1]-this.dataR[l-1][1])/e)*g,y=this.dataR[l-1][0],x=this.dataR[l-1][1];0<=m-i;)y+=p,x+=f,r=this.offSetY+Conversion.kmToDDNorth(.001*x),this.toECEF?(s.push([a.toFixed(1),Conversion.toECEF(r,this.offSetX+Conversion.kmToDDEast(r,.001*y),d)]),a+=.1):s.push([r,this.offSetX+Conversion.kmToDDEast(r,.001*y),d]),m-=i,o&&(p=c*(i=n)*u,f=h*i*u,o=!1);m<i&&.001<m&&(o=!0,i=n-m)}}for(var M="",v=a.toFixed(1).toString().length,l=0;l<s.length;l++)this.toECEF?M+=s[l][0].toString().padStart(v," ")+","+s[l][1]+"\n":M+=s[l][0]+", "+s[l][1]+"\n";this.toECEF?download(t+".csv",M,"application/csv;charset=utf-8;"):download(t+".txt",M,"data:text/plain;charset=utf-8;")}else alert("No data recorded.")},downloadData:function(e,n){var o={};if(o.trail=Trail.exportData(),o.recordedData=this.dataR,o.speedData=this.speedData,o.altitudeData=this.altData,o.timeData=this.timeData,o.coordinates={lat:this.offSetY,lng:this.offSetX},o.zoom=map.getZoom(),"txt"!=n){const l=new Date;var i=l.toISOString();let t='<?xml version="1.0"?><gpx xmlns="http://www.topografix.com/GPX/1/1" xmlns:gpxx="http://www.garmin.com/xmlschemas/GpxExtensions/v3" xmlns:gpxtrkx="http://www.garmin.com/xmlschemas/TrackStatsExtension/v1" xmlns:gpxtpx="http://www.garmin.com/xmlschemas/TrackPointExtension/v1" creator="ECEF Path Generator" version="2.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd http://www.garmin.com/xmlschemas/GpxExtensions/v3 http://www8.garmin.com/xmlschemas/GpxExtensionsv3.xsd http://www.garmin.com/xmlschemas/TrackStatsExtension/v1 http://www8.garmin.com/xmlschemas/TrackStatsExtension.xsd http://www.garmin.com/xmlschemas/TrackPointExtension/v1 http://www.garmin.com/xmlschemas/TrackPointExtensionv1.xsd"><metadata><link href="https://github.com/fpdf-easytable/ECEF_path_generator"><text>ECEF Path Generator</text></link>';t+="<time>"+i+"</time>",t+="<desc>"+document.getElementById("gpxDesc").value.trim()+"</desc>",t+="</metadata><trk>",document.getElementById("gpxDesc").value="";for(var n=roundNumber(this.wkDistance,3),i=document.getElementById("elapsedtime").innerHTML,s=0,a=0;a<o.speedData.length;a++)s<o.speedData[a]&&(s=o.speedData[a]);for(var r=0,d=1e5,a=0;a<o.altitudeData.length;a++)r<o.altitudeData[a]&&(r=o.altitudeData[a]),o.altitudeData[a]<d&&(d=o.altitudeData[a]);t+="<name>"+e+"</name><extensions><gpxx:TrackExtension>",t+="<gpxx:DisplayColor>Blue</gpxx:DisplayColor></gpxx:TrackExtension><gpxtrkx:TrackStatsExtension>",t+="<gpxtrkx:Distance>"+n+"</gpxtrkx:Distance>",t+="<gpxtrkx:TotalElapsedTime>"+i+"</gpxtrkx:TotalElapsedTime>",t+="<gpxtrkx:MaxSpeed>"+s+"</gpxtrkx:MaxSpeed>",t+="<gpxtrkx:MaxElevation>"+r+"</gpxtrkx:MaxElevation>",t+="<gpxtrkx:MinElevation>"+d+"</gpxtrkx:MinElevation>",t+="</gpxtrkx:TrackStatsExtension></extensions><trkseg>";for(a=0;a<o.trail.length;a++)t+='<trkpt lat="'+o.trail[a].lat+'" lon="'+o.trail[a].lng+'"></trkpt>';t+="</trkseg></trk></gpx>",download(e+".gpx",t,"data:text/xml;charset=utf-8;")}else download(e+".txt",JSON.stringify(o),"data:text/plain;charset=utf-8;")},upload:function(t){var e;this.erase();try{e=JSON.parse(t.toString())}catch(t){return void alert("File could not be loaded because it has bad syntax or it's corrupted.")}if(e.hasOwnProperty("coordinates")){let t=defaultZoom;e.hasOwnProperty("zoom")&&(t=e.zoom),this.setCoordinates(e.coordinates.lat,e.coordinates.lng,t)}if(this.head=0,e.hasOwnProperty("trail"))for(var n=0;n<e.trail.length;n++)Trail.addPointLatLng(e.trail[n]),this.head++;e.hasOwnProperty("recordedData")&&(this.dataR=e.recordedData),e.hasOwnProperty("speedData")&&(this.speedData=e.speedData,this.speed=this.speedData[0],gadgetModule.speed.innerHTML=roundNumber(this.speedData[0],2)),e.hasOwnProperty("altitudeData")&&(this.altData=e.altitudeData),gadgetModule.totalDistance.innerHTML=roundNumber(Trail.getTrailLengthKm(),2),Trail.moveToStart(),controlModule.fire("recordingFinished")},speedStep:.5,speedStep5:5,speedStep2:2,speedStep1:1,maxSpeed:350,changeSpeed:function(t){var e=.5;81==t||87==t?e=this.speedStep5:65==t||83==t?e=this.speedStep2:88==t||90==t?e=this.speedStep1:37!=t&&39!=t||(e=this.speedStep),(37!=t&&81!=t&&65!=t&&90!=t?1:-1)<0?(this.speed>=e&&(this.speed-=e),this.speed<=0&&(this.speed=.5)):this.speed<=this.maxSpeed-e?this.speed+=e:this.speed=this.maxSpeed,document.getElementById("speed").innerHTML=roundNumber(this.speed,2)},setSpeed:function(t){this.speed=Math.abs(t),document.getElementById("speed").innerHTML=roundNumber(this.speed,2)}};function download(t,e,n){e=new Blob([e],{type:n});window.navigator.msSaveBlob?navigator.msSaveBlob(e,t):((n=document.createElement("a")).setAttribute("href",URL.createObjectURL(e)),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)),popUpAPI.closing()}drawer.init(),controlModule.setZoom(13.5),window.addEventListener("keydown",function(t){38==t.keyCode||40==t.keyCode?controlModule.changeAltitude(t.keyCode):37!=t.keyCode&&39!=t.keyCode&&81!=t.keyCode&&87!=t.keyCode&&65!=t.keyCode&&83!=t.keyCode&&88!=t.keyCode&&90!=t.keyCode||drawer.changeSpeed(t.keyCode)}),document.onkeydown=function(t){t=(t=t||window.event).keyCode;if(37<=t&&t<=40)return!1},window.addEventListener("DOMContentLoaded",function(){var e,n,t,o;window.scrollTo(0,0),e=document.getElementById("dim"),n=document.getElementById("pop_wrapper"),t=document.getElementById("pop_up"),o=document.getElementById("popup_content"),n.style.top=.1*window.innerHeight+"px",t.style.maxHeight=.8*window.innerHeight+"px",popUpAPI={display:function(){e.style.display="block",n.style.visibility="visible"},closing:function(t){void 0===t?(n.style.visibility="hidden",e.style.display="none",document.getElementById("ecef").style.display="none",document.getElementById("rawData").style.display="none",document.getElementById("gpxData").style.display="none",document.getElementById("configuration").style.display="none",document.getElementById("description").style.display="none"):t.stopPropagation()},exportECEF:function(){document.getElementById("popup_title").innerHTML="Export to ECEF",document.getElementById("ecef").style.display="block",this.display()},processECEF:function(){var t=document.getElementById("frequency"),e=document.getElementById("fileName"),n=Number(t.value.trim());Number.isInteger(n)&&0!=n?e.value.trim()?(popUpAPI.wait(),drawer.changeFrequency(n),drawer.processData(e.value.trim()),t.value="",e.value=""):alert("Please enter a valid file name."):alert("Please enter a valid integer frequency.")},download:function(){document.getElementById("popup_title").innerHTML="Download Path Configuration",document.getElementById("rawData").style.display="block",this.display()},downloadGPX:function(){document.getElementById("popup_title").innerHTML="Download Path GPX",document.getElementById("gpxData").style.display="block",this.display()},settingsECEF:function(){document.getElementById("popup_title").innerHTML="Settings",document.getElementById("configuration").style.display="block",this.display()},whatisit:function(){document.getElementById("popup_title").innerHTML="Description",document.getElementById("description").style.display="block",this.display()},wait:function(){document.getElementById("popup_title").innerHTML="Processing data",this.display()},processDownload:function(t,e,n){t.value.trim()?(drawer.downloadData(t.value.trim(),n),t.value="",this.closing(),document.getElementById(e).style.display="none"):alert("Please enter a valid file name.")}},document.getElementById("closePopUp").addEventListener("click",function(){popUpAPI.closing()}),e.addEventListener("click",function(){popUpAPI.closing()}),n.addEventListener("click",function(){popUpAPI.closing()}),o.addEventListener("click",function(t){popUpAPI.closing(t)}),document.getElementById("export").addEventListener("click",function(){popUpAPI.exportECEF()}),document.getElementById("settings").addEventListener("click",function(){popUpAPI.settingsECEF()}),document.getElementById("ecefButton").addEventListener("click",function(){popUpAPI.processECEF()}),document.getElementById("exportData").addEventListener("click",function(){popUpAPI.download()}),document.getElementById("exportGPX").addEventListener("click",function(){popUpAPI.downloadGPX()}),document.getElementById("moveToBtn").addEventListener("click",function(){drawer.getPositionFromPointer=!drawer.getPositionFromPointer&&drawer.canMove(),drawer.getPositionFromPointer?document.getElementById("moveToBtn").style.fontWeight="bold":document.getElementById("moveToBtn").style.fontWeight="normal"}),document.getElementById("canvasContainer").addEventListener("mousedown",function(t){drawer.getPositionFromPointer&&globalSettings.getPosition3(function(e,n){var t=globalSettings.containerPointToLatLng(e,n);drawer.setCoordinates(t.lat,t.lng,map.getZoom()),map.once("moveend",function(){var t=globalSettings.containerCenter();t.add2(-1*e,-1*n),Trail.onTranslate(t.x,t.y)}.bind(this))},t)}),document.getElementById("whatisit").addEventListener("click",function(){popUpAPI.whatisit()}),document.getElementById("rawDataButton").addEventListener("click",function(){popUpAPI.processDownload(document.getElementById("fileNameR"),"rawData","txt")}),document.getElementById("gpxDataButton").addEventListener("click",function(){popUpAPI.processDownload(document.getElementById("gpxNameR"),"gpxData","gpx")}),document.getElementById("locationButton").addEventListener("click",function(){var t=Number(document.getElementById("latitude").value),e=Number(document.getElementById("longitude").value);Number.isNaN(t)||Number.isNaN(e)?alert("Please enter a valid number."):(drawer.setCoordinates(t,e,defaultZoom),document.cookie="longitude="+e,document.cookie="latitude="+t)}),document.getElementById("coloursButton").addEventListener("click",function(){var t=document.getElementById("trail_colour").value,e=document.getElementById("mover_colour").value;""==(t=t.trim())&&(t="#ffb366"),""==(e=e.trim())&&(e="blue"),Trail.setColours(t,e)}),""==document.cookie&&(document.cookie="whatisit=yes"),o=ReadCookie(),drawer.setCoordinates(o.lat,o.lng,defaultZoom)});